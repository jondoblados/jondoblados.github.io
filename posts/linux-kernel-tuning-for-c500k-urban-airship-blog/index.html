<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-us">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Linux Kernel Tuning for C500k | Urban Airship Blog | Amalgamated Thoughts </title>

<meta property='og:title' content='Linux Kernel Tuning for C500k | Urban Airship Blog - Amalgamated Thoughts '>
<meta property='og:description' content='By Jared &#34;Lucky&#34; Kuolt on September 29, 2010Like the idea of working on large scale problems? We&rsquo;re hiring talented engineers, and would love to chat with you &ndash; check it out!&nbsp;
Note: Concurrency, as defined in this article, is the same as it is for The C10k problem: concurrent clients (or sockets).
At Urban Airship we recently published a blog post about scaling beyond 500,000 concurrent socket connections. Hitting these numbers was not a trivial exercise so we&rsquo;re going to share what we&rsquo;ve come across during our testing.'>
<meta property='og:url' content='https://jondoblados.github.io/posts/linux-kernel-tuning-for-c500k-urban-airship-blog/'>
<meta property='og:site_name' content='Amalgamated Thoughts '>
<meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/46ccde2b8eedf0f23a9d64dfb6566d9d?s=256'><meta property='article:author' content='https://facebook.com/JonDoblados'><meta property='article:section' content='Posts'><meta property='article:tag' content='GNU/Linux'><meta property='article:tag' content='Systems Administration'><meta property='article:published_time' content='2010-09-30T10:24:00Z'/><meta property='article:modified_time' content='2010-09-30T10:24:00Z'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@JonDoblados'><meta name='twitter:creator' content='@JonDoblados'>

<link href="https://jondoblados.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Amalgamated Thoughts " />

<link rel="stylesheet" href="/css/style.css"/><link rel='stylesheet' href='https://jondoblados.github.io/css/custom.css'><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://jondoblados.github.io">
          <h1 class="title is-4">Amalgamated Thoughts </h1>
        </a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/jondoblados'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="facebook" href='https://facebook.com/JonDoblados'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/JonDoblados'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="email" href='mailto:jon@doblados.net'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="linkedin" href='https://linkedin.com/in/JonDoblados'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path stroke-width="1.8" d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      

      
    </nav>

  </div>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/gnu/linux">#GNU/Linux</a>



  
  | <a class="subtitle is-6" href="/tags/systems-administration">#Systems Administration</a>
  

      
    </div>
    <h2 class="subtitle is-6">September 30, 2010</h2>
    <h1 class="title">Linux Kernel Tuning for C500k | Urban Airship Blog</h1>
    
    <div class="content">
      <div class="posterous_bookmarklet_entry"><br/><blockquote><br/><div><br/><h4>By Jared "Lucky" Kuolt on September 29, 2010</h4><br/><div style="background: #e1dcd6; border: 1px solid #d7d2cc; padding: 10px;">Like the idea of working on large scale problems? We&rsquo;re hiring talented engineers, and would love to chat with you &ndash; <a href="http://urbanairship.com/jobs/">check it out</a>!</div><br/><p>&nbsp;</p><br/><blockquote><br/><p>Note: Concurrency, as defined in this article, is the same as it is for <a href="http://www.kegel.com/c10k.html">The C10k problem</a>: concurrent clients (or sockets).</p><br/></blockquote><br/><p>At Urban Airship we recently published a <a href="http://blog.urbanairship.com/blog/2010/08/24/c500k-in-action-at-urban-airship/">blog post</a> about scaling beyond 500,000 concurrent socket connections. Hitting these numbers was not a trivial exercise so we&rsquo;re going to share what we&rsquo;ve come across during our testing. This guide is specific to Linux and has some information related to Amazon EC2, but it is not EC2-centric. These principles should apply to just about any Linux platform.</p><br/><p>For our usage, squeezing out as many possible socket connections per server is valuable. Instead of running 100 servers with 10,000 connections each, we&rsquo;d rather run 2 servers with 500,000 connections apiece. To do this we made the socket servers pretty much <em>just</em> socket servers. Any communication between the client and server is passed through <a href="http://kr.github.com/beanstalkd/">a queue</a> and processed by a worker. Having less for the socket server to do means less code, cpu-usage, and ram-usage.</p><br/><p><a name='more'></a>To get to these numbers we must consider the Linux kernel itself. A number of configurations needed tweaking. But first, an anecdote.</p><br/><h3>The Kernel, OOM, LOWMEM, and You</h3><br/><p>We first tested our code on a local Linux box that had Ubuntu 64-bit with 6GB of RAM, connecting with several Ubuntu VMs per client using bridged network adapters so we could ramp up our connections. We&rsquo;d fire up the server and run our clients locally to see just how many connections we could hit. We noticed that we could hit 512,000 with our Java server not even breaking a sweat.</p><br/><p>The next step was to test on EC2. We first wanted to see what sort of numbers we could get on &ldquo;Small&rdquo; instances, which are 1.7GB 32-bit VMs. We also had to fire up a number of other EC2 instances to act as clients.</p><br/><p>We watched the numbers go up and up without a hitch until, seemingly randomly, the Java server fell over. It didn&rsquo;t print any exceptions or die gracefully&mdash;it was killed.</p><br/><p>We tried the same process again to see if we could replicate the behavior. Killed again.</p><br/><p>Grepping through syslog, we found this line:</p><br/><div class="CodeRay"><br/><div class="code"><br/><div class="CodeRay"><br/>  <div class="code"><pre>Out of Memory: Killed process 2178 java</pre></div><br/></div><br/><br/></div><br/></div><br/><p>The OOM-killer killed the Java process. Having watched the free RAM closely, this was odd because we had at least 500MB free at the time of the kill.</p><br/><p>The next time we ran it we watched the contents of <code>/proc/meminfo</code>. What we noticed was a steady decline of the field &ldquo;LowFree&rdquo;, the amount of LOWMEM that is available. LOWMEM is the kernel-addressable RAM space used for kernel data. Data like socket buffers.</p><br/><p>As we increased the number of sockets each socket&rsquo;s buffers increased the amount of LOWMEM used. Once LOWMEM was full the kernel (instead of simply panicking) found the user process responsible for the usage and promptly killed it so it could continue to function.</p><br/><p>On a standard EC2 Small, the configuration is such that the LOWMEM is around 717MB and the rest is &ldquo;given&rdquo; to the user. The kernel is smart about reallocating LOWMEM for the user, but not the other way around. The assumption is that the kernel will use very little ram, or at least a predictable finite amount, and the user should be allowed to go crazy. What we needed with our socket server was just the opposite. We needed the kernel to use all the ram it needed&mdash;our Java server rarely uses above a few hundred MB.</p><br/><p>(For an in-depth rundown, take a look at <a href="http://kerneltrap.org/node/2450">High Memory In The Linux Kernel</a>)</p><br/><p>On a 32-bit system the kernel-addressable RAM space is 4GB. Making sure the proper space reserved for the kernel is important. But on 64-bit (x86-64) Linux the <a href="http://en.wikipedia.org/wiki/X86-64#Linux">kernel-addressable space is 64TB (terabytes)</a>. At the current state of computing this is effectively limitless, and as such you will not even see LowMem in <code>/proc/meminfo</code> because it is <em>all</em> LOWMEM.</p><br/><p>So we created some EC2 Large instances (each of which is 64-bit with 7.5GB of RAM) and ran our tests again, this time without any surprises. The sockets were added happily and the kernel took all the RAM it needed.</p><br/><p>Long story short, you can only scale to so many sockets on a 32-bit platform.</p><br/><h3>Kernel Options</h3><br/><p>Several parameters exist to allow for tuning and tweaking of socket-related parameters. In <code>/etc/sysctl.conf</code> there are a few options we&rsquo;ve modified.</p><br/><p>First is <code>fs.file-max</code>, the maximum file descriptor limit. The default is quite low so this should be adjusted. Be careful if you&rsquo;re not ready to go super high.</p><br/><p>Second, we have the socket buffer parameters <code>net.ipv4.tcp_rmem</code> and <code>net.ipv4.tcp_wmem</code>. These are the buffers for reads and writes respectively. Each requires three integer inputs: min, default, and max. These each correspond to the number of bytes that may be buffered for a socket. Set these low with a tolerant max to reduce the amount of ram used for each socket.</p><br/><p>The relevant portions of our config look like this:</p><br/><div class="CodeRay"><br/><div class="code"><br/><div class="CodeRay"><br/>  <div class="code"><pre>fs.file-max = 999999<br/>net.ipv4.tcp_rmem = 4096 4096 16777216<br/>net.ipv4.tcp_wmem = 4096 4096 16777216</pre></div><br/></div><br/><br/></div><br/></div><br/><p>Meaning that the kernel allows for 999,999 open file descriptors and each socket buffer has a minimum and default 4096-byte buffer, with a sensible max of 16MB.</p><br/><p>We also modified <code>/etc/security/linux.conf</code> to allow for 999,999 open file descriptors for all users.</p><br/><div class="CodeRay"><br/><div class="code"><br/><div class="CodeRay"><br/>  <div class="code"><pre>#                 <br/>*               -       nofile         999999</pre></div><br/></div><br/><br/></div><br/></div><br/><p>You may want to look at the <a href="http://ss64.com/bash/limits.conf.html">manpage</a> for more information.</p><br/><h3>Testing</h3><br/><p>When testing, we were able to get about 64,000 connections per client by increasing the number of ephemeral ports allowed on both the client and the server.</p><br/><div class="CodeRay"><br/><div class="code"><br/><div class="CodeRay"><br/>  <div class="code"><pre>echo &quot;1024 65535&quot; &gt; /proc/sys/net/ipv4/ip_local_port_range</pre></div><br/></div><br/><br/></div><br/></div><br/><p>This effectively allows every ephemeral port above 1024 be used instead of the default, which is a much lower (and typically more sane) default.</p><br/><h3>The 64k Connection Myth</h3><br/><p>It&rsquo;s a common misconception that you can only accept 64,000 connections per IP address and the only way around it is to add more IPs. This is <em>absolutely false</em>.</p><br/><p>The misconception begins with the premise that there are only so many ephemeral ports per IP. The truth is that the limit is based on the IP <em>pair</em>, or said another way, the client and server IPs together. A single client IP can connect to a server IP 64,000 times and so can another client IP.</p><br/><p>Were this myth true it would be a significant and easy-to-exploit DDoS vector.</p><br/><h3>Scaling for Everyone</h3><br/><p>When we set out to establish half a million connections on a single server we were diving deep into water that wasn&rsquo;t well documented. Sure, we know that C10k is relatively trivial, but how about an order of magnitude (and then some) above that?</p><br/><p>Fortunately we&rsquo;ve been able to achieve success without too many serious problems. Hopefully our solutions can help save time for those out there looking to solve the same problems.</p><br/><p>Posted in <a href="http://blog.urbanairship.com/android/" title="View all posts in android" rel="category tag">android</a> &bull; Tagged with <a href="http://blog.urbanairship.com/blog/tag/64bit/" rel="tag">64bit</a>, <a href="http://blog.urbanairship.com/blog/tag/c500k/" rel="tag">c500k</a>, <a href="http://blog.urbanairship.com/blog/tag/ec2/" rel="tag">ec2</a>, <a href="http://blog.urbanairship.com/blog/tag/kernel/" rel="tag">kernel</a>, <a href="http://blog.urbanairship.com/blog/tag/kittensftw/" rel="tag">kittensftw</a>, <a href="http://blog.urbanairship.com/blog/tag/linux/" rel="tag">linux</a></p><br/><h3>5 Responses</h3><br/><ol><br/><li> <img src="http://0.gravatar.com/avatar/c4f07c10c49799c211793cca5b3d3ee9?s=64&amp;d=&lt;path_to_url&gt;&amp;r=G" height="64" alt="" width="64" /><br/><p>&nbsp;</p><br/><div><br/><p><cite><a href="http://magarshak.com" rel="external nofollow">Magarshak</a></cite> at 3:48 pm on September 29, 2010</p><br/><p>Wow, amazing! Now if only I could load 500k concurrent PHP scripts at the same time, without having 2MB eaten up by each in memory.</p><br/><a href="http://blog.urbanairship.com/blog/2010/09/29/linux-kernel-tuning-for-c500k/?replytocom=827#respond" class="comment-reply-link" rel="nofollow">Reply</a></div><br/><ul><br/><li> <img src="http://0.gravatar.com/avatar/e904ebfe4e19721369c3ee4788cf1ef0?s=64&amp;d=&lt;path_to_url&gt;&amp;r=G" height="64" alt="" width="64" /><br/><p>&nbsp;</p><br/><div><br/><p><cite>seaesliek</cite> at 4:52 pm on September 29, 2010</p><br/><p>You can: Write in C.</p><br/><a href="http://blog.urbanairship.com/blog/2010/09/29/linux-kernel-tuning-for-c500k/?replytocom=828#respond" class="comment-reply-link" rel="nofollow">Reply</a></div><br/></li><br/></ul><br/></li><br/><li> <img src="http://1.gravatar.com/avatar/57eb5bcc18e3f4c08ed6111fb48b96fc?s=64&amp;d=&lt;path_to_url&gt;&amp;r=G" height="64" alt="" width="64" /><br/><p>&nbsp;</p><br/><div><br/><p><cite>Cristian</cite> at 7:15 pm on September 29, 2010</p><br/><p>Why is this &ldquo;posted in android&rdquo;?</p><br/><a href="http://blog.urbanairship.com/blog/2010/09/29/linux-kernel-tuning-for-c500k/?replytocom=829#respond" class="comment-reply-link" rel="nofollow">Reply</a></div><br/><ul><br/><li> <img src="http://0.gravatar.com/avatar/e4804b99a5e5e0224bd974d6bac0a578?s=64&amp;d=&lt;path_to_url&gt;&amp;r=G" height="64" alt="" width="64" /><br/><p>&nbsp;</p><br/><div><br/><p><cite>lucky</cite> at 7:37 pm on September 29, 2010</p><br/><p>Cristian,</p><br/><p>We created the C500k for our Android Push infrastructure.</p><br/><a href="http://blog.urbanairship.com/blog/2010/09/29/linux-kernel-tuning-for-c500k/?replytocom=830#respond" class="comment-reply-link" rel="nofollow">Reply</a></div><br/></li><br/></ul><br/></li><br/><li> <img src="http://0.gravatar.com/avatar/276da40e2b12446e2e5f994f36c794c3?s=64&amp;d=&lt;path_to_url&gt;&amp;r=G" height="64" alt="" width="64" /><br/><p>&nbsp;</p><br/><div><br/><p><cite>Wil</cite> at 8:20 pm on September 29, 2010</p><br/><p>Great article!  As someone who once struggled to understand these settings in the past, this is the best description I&rsquo;ve seen.</p><br/><p>One minor correction: it&rsquo;s /etc/security/limits.conf, not /etc/security/linux.conf.</p><br/><a href="http://blog.urbanairship.com/blog/2010/09/29/linux-kernel-tuning-for-c500k/?replytocom=831#respond" class="comment-reply-link" rel="nofollow">Reply</a></div><br/></li><br/></ol><br/><h3>Leave a Reply</h3><br/><div><small><a href="http://blog.urbanairship.com/blog/2010/09/29/linux-kernel-tuning-for-c500k#" rel="nofollow" style="display: none;">Click here to cancel reply.</a></small></div><br/></div><br/></blockquote><br/><div class="posterous_quote_citation">via <a href="http://blog.urbanairship.com/blog/2010/09/29/linux-kernel-tuning-for-c500k/">blog.urbanairship.com</a></div><br/><p>This is so helpful. Everything described here reminded me and a fellow-sysad what we went through troubleshooting an OOM issue. So uncanny, it's de ja vu!</p><br/></div>

      
      <div class="related">

<h3>Similar articles:</h3>
<ul>
	
	<li><a href="/posts/how-to-count-instances-of-an-ip-address-in-a-log-file/">How to count instances of an IP address in a log file</a></li>
	
	<li><a href="/posts/using-non-standard-ssh-port-with-tortoisesvn/">Using non-standard SSH port with TortoiseSVN</a></li>
	
	<li><a href="/posts/piix3-cannot-attach-drive-to-the-secondary-master/">PIIX3 cannot attach drive to the Secondary Master</a></li>
	
	<li><a href="/posts/putty-on-my-phone-ftw-isp-was-acting-up-and-was-able-to-get-apache-towork-sometime-past-3pm.-post-mortem-shortly./">Putty on my phone FTW! ISP was acting up and was able to get Apache to work sometime past 3pm. Post-mortem shortly.</a></li>
	
	<li><a href="/posts/being-a-systems-administrator-37signals-podcast/">Being a Systems Administrator @37signals (Podcast)</a></li>
	
</ul>
</div>
      
    </div>
    
  </div>
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
  
    <script type="text/javascript">
      var disqus_shortname = 'amalgamated-thoughts';
      function disqus() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }
  
      disqus();
  

    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="https://jondoblados.github.io/">Jon Doblados</a> 2018</p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>



</body>
</html>

